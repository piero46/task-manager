name: Build Android APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Qt (6.8.0 for Android)
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.8.0'
        target: 'android'
        arch: 'android_arm64_v8a'
        modules: 'qtshadertools'
        set-env: true

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Android SDK & NDK
      run: |
        rm -rf $ANDROID_HOME/cmdline-tools/latest
        mkdir -p $ANDROID_HOME/cmdline-tools/latest
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip  
        unzip -q commandlinetools-linux-*.zip -d /tmp
        mv /tmp/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
        yes | sdkmanager --sdk_root=$ANDROID_HOME "platforms;android-33" "build-tools;33.0.2" "ndk;25.2.9519653"

    - name: Install Vulkan Headers
      run: |
        sudo apt-get update
        sudo apt-get install -y libvulkan-dev

    - name: Build All (including APK if possible)
      run: |
        export ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653
        cmake -B build -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=$QT_HOST_PATH/lib/cmake/Qt6/qt.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DQT_ANDROID_PLATFORM_LEVEL=33
        cmake --build build --target all

    - name: Upload APK (if exists)
      uses: actions/upload-artifact@v4
      with:
        name: taskmanager-apk
        path: build/android-build/*.apk